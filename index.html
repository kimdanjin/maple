<script>
    let videoElement = document.getElementById("videoElement");
    let canvasElement = document.getElementById("canvasElement");
    let cropCanvas = document.getElementById("cropCanvas"); // OCR ì˜ì—­ ìº”ë²„ìŠ¤
    let startCaptureButton = document.getElementById("startCapture");
    let ocrResult = document.getElementById("ocrResult");
    let previousValueDisplay = document.getElementById("previousValue");
    let differenceDisplay = document.getElementById("difference");

    let stream;
    let isOCRRunning = false;  // OCRì´ ì§„í–‰ ì¤‘ì¸ì§€ ì—¬ë¶€
    let ocrInterval;  // OCR ì‹¤í–‰ íƒ€ì´ë¨¸
    let previousValue = null;  // ì´ì „ OCR ê°’
    let lastTimestamp = Date.now(); // ë§ˆì§€ë§‰ OCR ì‹¤í–‰ ì‹œê°„

    // âœ… 1. í™”ë©´ ê³µìœ  ì‹œì‘
    startCaptureButton.addEventListener("click", async () => {
        try {
            stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            videoElement.srcObject = stream;

            // í™”ë©´ ê³µìœ  ì‹œì‘ ì‹œ ë°”ë¡œ OCR ì‹¤í–‰
            runOCR();

            // OCRì„ 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
            ocrInterval = setInterval(runOCR, 60000);  

            startCaptureButton.disabled = true; // ë²„íŠ¼ ë¹„í™œì„±í™”
        } catch (err) {
            console.error("í™”ë©´ ê³µìœ  ì‹¤íŒ¨:", err.message);
        }
    });

    // âœ… 2. OCR ì‹¤í–‰ í•¨ìˆ˜ (1ë¶„ë§ˆë‹¤ ì‹¤í–‰)
    async function runOCR() {
        if (isOCRRunning) return; // OCRì´ ì‹¤í–‰ ì¤‘ì´ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
        isOCRRunning = true;

        let ctx = canvasElement.getContext("2d");
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;

        // ğŸ”¹ ë¹„ë””ì˜¤ í”„ë ˆì„ ìº¡ì²˜
        ctx.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);

        // ğŸ”¹ OCRí•  íŠ¹ì • ì˜ì—­ ì„¤ì • (ì˜ˆ: x=100, y=150, width=300, height=100)
        let cropX = 617;  // X ì¢Œí‘œ (ì™¼ìª½ì—ì„œ 100px)
        let cropY = 708;  // Y ì¢Œí‘œ (ìœ„ì—ì„œ 150px)
        let cropWidth = 120;  // ë„ˆë¹„ 300px
        let cropHeight = 16; // ë†’ì´ 100px

        // âœ… íŠ¹ì • ì˜ì—­ì„ ì˜ë¼ì„œ cropCanvasì— ë³µì‚¬
        let cropCtx = cropCanvas.getContext("2d");
        cropCanvas.width = cropWidth;
        cropCanvas.height = cropHeight;
        cropCtx.drawImage(canvasElement, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);

        // âœ… Tesseract.jsë¡œ OCR ì‹¤í–‰ (ë¹„ë™ê¸° ì²˜ë¦¬)
        Tesseract.recognize(
            cropCanvas,  // ì „ì²´ê°€ ì•„ë‹Œ íŠ¹ì • ì˜ì—­ë§Œ OCR ì‹¤í–‰
            "eng", // ì˜ì–´ë¡œ OCR
            {
                logger: m => console.log(m),
                tessedit_char_whitelist: "0123456789[]()" // ìˆ«ìì™€ ê´„í˜¸ë§Œ ì¸ì‹í•˜ë„ë¡ ì„¤ì •
            }
        ).then(({ data: { text } }) => {
            ocrResult.value = text; // OCR ê²°ê³¼ í‘œì‹œ
            processOCRResult(text); // OCR ê²°ê³¼ ì²˜ë¦¬
            isOCRRunning = false;  // OCR ì‹¤í–‰ ì™„ë£Œ í›„ ë‹¤ì‹œ ì‹¤í–‰ ê°€ëŠ¥
        }).catch(err => {
            console.error("OCR ì˜¤ë¥˜: ", err);
            isOCRRunning = false;  // ì˜¤ë¥˜ ë°œìƒ ì‹œ OCR ì¬ì‹œì‘ ê°€ëŠ¥
        });
    }

    // âœ… OCR ê²°ê³¼ì—ì„œ ìˆ«ì ì¶”ì¶œí•˜ê³  ì°¨ì´ ê³„ì‚°
    function processOCRResult(text) {
        // OCR ê²°ê³¼ì—ì„œ ìˆ«ì ì¶”ì¶œ (ì˜ˆ: 123123(12% ë˜ëŠ” 123123[12% í˜•íƒœë¡œ ì¶”ì¶œ)
        let matches = text.match(/\d+[\(\[]/); // ì˜ˆì‹œ: 123123( ë˜ëŠ” 123123[
        if (matches) {
            let currentValue = parseInt(matches[0].replace(/[\(\[]/, ""));  // ê´„í˜¸ë‚˜ ëŒ€ê´„í˜¸ë¥¼ ì œê±°í•œ ê°’
            if (previousValue !== null) {
                // ì´ì „ ê°’ê³¼ì˜ ì°¨ì´ ê³„ì‚°
                let difference = currentValue - previousValue;
                differenceDisplay.innerText = difference;
            }

            // ì´ì „ ê°’ ê°±ì‹ 
            previousValue = currentValue;
            previousValueDisplay.innerText = currentValue;
        }
    }
</script>
